{% from 'modules/variant_calling/deepvariant.j2' import deepvariant with context %}
{% from 'modules/variant_calling/deepsomatic.j2' import deepsomatic with context %}
{% from 'modules/variant_calling/clair3.j2' import clair3 with context %}
{% from 'modules/variant_calling/clairs.j2' import clairs with context %}
{% from 'modules/variant_calling/cutesv.j2' import cutesv with context %}
{% from 'modules/variant_calling/longshot.j2' import longshot with context %}
{% from 'modules/variant_calling/sniffles.j2' import sniffles with context %}
{% from 'modules/variant_calling/pbsv.j2' import pbsv with context %}
{% from 'modules/variant_calling/severus.j2' import severus with context %}
{% from 'modules/variant_calling/dysgu.j2' import dysgu with context %}
{% from 'modules/variant_calling/spectre.j2' import spectre with context %}
{% from 'modules/variant_calling/hifi_cnv.j2' import hifi_cnv with context %}

{%- macro constitutional_variant_calling(samples) %}

{%- for sample in samples.values() if sample.gltype in ('exome','genome') %}

  {% if not sample.aligners | length >= 1 %}
    {{- sample_aligners_did_not_traverse_to_module }}
  {% endif %}

  {% for aligner in sample.aligners %}

  {% if sample.gltype in 'exome' %}
    {% set taskPrefix = 'Exome' %}
  {% elif sample.gltype in 'genome' %}
    {% set taskPrefix = 'Genome' %}
  {% endif %}

  {% if long_read_only|default(true) and sample.glprep in 'longread' %}
    {%- if sample.subGroup|lower == 'constitutional' %}
      {% if tasks[taskPrefix+"_variant_calling_snp_indel_caller_deepvariant"]|default(true) %}
        {{- deepvariant(sample, aligner) }}
      {% endif %}

      {% if tasks[taskPrefix+"_variant_calling_snp_indel_caller_clair3"]|default(false) %}
        {{- clair3(sample, aligner) }}
      {% endif %}
    {% endif %}
  {% endif %}

  {% if sample.glprep in 'longread' %}
    {%- if sample.subGroup|lower == 'tumor' %}
      {% if tasks[taskPrefix+"_variant_calling_structural_caller_severus"]|default(true) %}
        {{- severus(sample, aligner) }}
      {% endif %}
    {% endif %}

    {% if tasks[taskPrefix+"_variant_calling_snp_indel_caller_longshot"]|default(false) %}
      {{- longshot(sample, aligner) }}
    {% endif %}

    {% if tasks[taskPrefix+"_variant_calling_structural_caller_cutesv"]|default(true) %}
      {{- cutesv(sample, aligner) }}
    {% endif %}

    {% if tasks[taskPrefix+"_variant_calling_structural_caller_sniffles"]|default(true) %}
      {{- sniffles(sample, aligner) }}
    {% endif %}

    {% if tasks[taskPrefix+"_variant_calling_structural_caller_dysgu"]|default(true) %}
      {{- dysgu(sample, aligner) }}
    {% endif %}

    {% if tasks[taskPrefix+"_variant_calling_cna_caller_spectre"]|default(true) %}
      {{- spectre(sample, aligner) }}
    {% endif %}

    {% if sample.rgpl in ('PACBIO') %}
      {% if tasks[taskPrefix+"_variant_calling_structural_caller_pbsv"]|default(false) %}
        {{- pbsv(sample, aligner) }}
      {% endif %}

      {% if tasks[taskPrefix+"_variant_calling_cna_caller_hificnv"]|default(true) %}
        {{- hifi_cnv(sample, aligner) }}
      {% endif %}
    {% endif %}
  {% endif %}

  {% endfor %}

{% endfor %}

{% endmacro %}

{% macro somatic_variant_calling(samples) %}

{% set pairs = [] %}
{% for tumor in samples.values() if tumor.subGroup|lower == 'tumor' and tumor.gltype in ('exome','genome') %}
  {% for normal in samples.values() if normal.subGroup|lower == 'constitutional' and normal.gltype == tumor.gltype and normal.assayCode == tumor.assayCode %}
  {% if long_read_only|default(true) and tumor.glprep in 'longread' %}
    {% set pair_name = normal.name + '-' + tumor.name %}
    {% do pairs.append({'name': pair_name, 'gltype': normal.gltype, 'normal': normal, 'tumor': tumor}) %}
  {% endif %}
  {% endfor %}
{% endfor %}

{# Start of the macro calls that will actually add the tasks to the workflow #}
{% for pair in pairs %}
  {% if pair.gltype in 'exome' %}
    {% set taskPrefix = 'Exome' %}
  {% elif pair.gltype in 'genome' %}
    {% set taskPrefix = 'Genome' %}
  {% endif %}

  {% for aligner in pair.tumor.aligners %}

  {% if tasks[taskPrefix+"_variant_calling_snp_indel_caller_deepsomatic"]|default(true) %}
    {{- deepsomatic(pair, aligner) }}
  {% endif %}

  {% if tasks[taskPrefix+"_variant_calling_snp_indel_caller_clairs"]|default(true) %}
    {{- clairs(pair, aligner) }}
  {% endif %}

  {% if tasks[taskPrefix+"_variant_calling_structural_caller_severus"]|default(true) %}
    {{- severus(pair, aligner) }}
  {% endif %}

  {% endfor %}

{% endfor %}

{% endmacro %}


