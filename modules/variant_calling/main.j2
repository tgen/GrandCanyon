{% from 'modules/variant_calling/snv_indel/deepvariant.j2' import deepvariant with context %}
{% from 'modules/variant_calling/snv_indel/deepsomatic.j2' import deepsomatic with context %}
{% from 'modules/variant_calling/snv_indel/clair3.j2' import clair3 with context %}
{% from 'modules/variant_calling/snv_indel/clairs.j2' import clairs with context %}
{% from 'modules/variant_calling/snv_indel/longshot.j2' import longshot with context %}
{% from 'modules/variant_calling/structural/cutesv.j2' import cutesv with context %}
{% from 'modules/variant_calling/structural/sniffles.j2' import sniffles with context %}
{% from 'modules/variant_calling/structural/pbsv.j2' import pbsv with context %}
{% from 'modules/variant_calling/structural/severus.j2' import severus with context %}
{% from 'modules/variant_calling/structural/dysgu.j2' import dysgu with context %}
{% from 'modules/variant_calling/structural/gridss.j2' import gridss with context %}
{% from 'modules/variant_calling/copy_number/spectre.j2' import spectre with context %}
{% from 'modules/variant_calling/copy_number/hifi_cnv.j2' import hifi_cnv with context %}

{%- macro constitutional_variant_calling(samples) %}

{%- for sample in samples.values() if sample.gltype in ('exome','genome') and sample.subGroup|lower == 'constititional' %}

  {% for aligner in sample.aligners %}

    {% if sample.gltype in 'exome' %}
      {% set taskPrefix = 'Exome' %}
    {% elif sample.gltype in 'genome' %}
      {% set taskPrefix = 'Genome' %}
    {% endif %}

    {############
    # snv and indel variant callers
    ############}

    {% if tasks[taskPrefix+"_variant_calling_snp_indel_caller_deepvariant"]|default(false) %}
      {{- deepvariant(sample, aligner) }}
    {% endif %}

    {% if tasks[taskPrefix+"_variant_calling_snp_indel_caller_clair3"]|default(false) %}
      {{- clair3(sample, aligner) }}
    {% endif %}

    {% if sample.glprep in 'longread' %}
      {% if tasks[taskPrefix+"_variant_calling_snp_indel_caller_longshot"]|default(false) %}
        {{- longshot(sample, aligner) }}
      {% endif %}
    {% endif %}

    {############
    # structural variant callers
    ############}

    {% if sample.glprep in 'longread' %}

      {% if tasks[taskPrefix+"_variant_calling_structural_caller_cutesv"]|default(false) %}
        {{- cutesv(sample, aligner) }}
      {% endif %}

      {% if tasks[taskPrefix+"_variant_calling_structural_caller_sniffles"]|default(false) %}
        {{- sniffles(sample, aligner) }}
      {% endif %}

      {% if tasks[taskPrefix+"_variant_calling_structural_caller_dysgu"]|default(false) %}
        {{- dysgu(sample, aligner) }}
      {% endif %}

      {% if sample.rgpl in ('PACBIO') %}
        {% if tasks[taskPrefix+"_variant_calling_structural_caller_pbsv"]|default(false) %}
          {{- pbsv(sample, aligner) }}
        {% endif %}
      {% endif %}

    {% else %}

      {% if tasks[taskPrefix+"_variant_calling_structural_caller_gridss"]|default(false) %}
        {{- gridss(sample, aligner) }}
      {% endif %}

      {% if tasks[taskPrefix+"_variant_calling_structural_caller_manta"]|default(false) %}
        {{- manta(sample, aligner) }}
      {% endif %}

    {% endif %}

    {############
    # copy number variant callers
    ############}

    {% if sample.glprep in 'longread' %}

      {% if tasks[taskPrefix+"_variant_calling_cna_caller_spectre"]|default(false) %}
        {{- spectre(sample, aligner) }}
      {% endif %}

      {% if sample.rgpl in ('PACBIO') %}
        {% if tasks[taskPrefix+"_variant_calling_cna_caller_hificnv"]|default(false) %}
          {{- hifi_cnv(sample, aligner) }}
        {% endif %}
      {% endif %}

    {% else %}

    {% endif %}

  {% endfor %}

{% endfor %}

{% endmacro %}

{% macro somatic_variant_calling(samples) %}

{%- for sample in samples.values() if sample.gltype in ('exome','genome') and sample.subGroup|lower == 'tumor' %}

  {% if sample.gltype in 'exome' %}
    {% set taskPrefix = 'Exome' %}
  {% elif sample.gltype in 'genome' %}
    {% set taskPrefix = 'Genome' %}
  {% endif %}

  {% for aligner in sample.aligners %}

    {% if tasks[taskPrefix+"_variant_calling_structural_caller_severus"]|default(false) %}
      {{- severus(sample, aligner) }}
    {% endif %}

    {% if tasks[taskPrefix+"_variant_calling_snp_indel_caller_deepsomatic"]|default(false) %}
      {{- deepsomatic(sample, aligner) }}
    {% endif %}

{% endfor %}

{% set pairs = [] %}
{% for tumor in samples.values() if tumor.subGroup|lower == 'tumor' and tumor.gltype in ('exome','genome') %}
  {% for normal in samples.values() if normal.subGroup|lower == 'constitutional' and normal.gltype == tumor.gltype and normal.assayCode == tumor.assayCode %}
    {% set pair_name = normal.name + '-' + tumor.name %}
    {% do pairs.append({'name': pair_name, 'gltype': normal.gltype, 'normal': normal, 'tumor': tumor}) %}
  {% endfor %}
{% endfor %}

{# Start of the macro calls that will actually add the tasks to the workflow #}
{% for pair in pairs %}
  {% if pair.gltype in 'exome' %}
    {% set taskPrefix = 'Exome' %}
  {% elif pair.gltype in 'genome' %}
    {% set taskPrefix = 'Genome' %}
  {% endif %}

  {% for aligner in pair.tumor.aligners %}

    {############
    # snv and indel variant callers
    ############}
    
    {% if tasks[taskPrefix+"_variant_calling_snp_indel_caller_deepsomatic"]|default(false) %}
      {{- deepsomatic(pair, aligner) }}
    {% endif %}

    {% if tasks[taskPrefix+"_variant_calling_snp_indel_caller_clairs"]|default(false) %}
      {{- clairs(pair, aligner) }}
    {% endif %}

    {############
    # structural variant callers
    ############}

    {% if pair.glprep in 'longread' %}

      {% if tasks[taskPrefix+"_variant_calling_structural_caller_severus"]|default(false) %}
        {{- severus(pair, aligner) }}
      {% endif %}

    {% else %}

      {% if tasks[taskPrefix+"_variant_calling_structural_caller_gridss"]|default(false) %}
        {{- gridss(pair, aligner) }}
      {% endif %}
    
    {% endif %}

    {############
    # copy number variant callers
    ############}

    {% if tasks[taskprefix+"_variant_calling_cna_caller_gatk_cnv"]|default(false) %}
      {{- gatk_cnv(sample, aligner) }}
    {% endif %}

  {% endfor %}

{% endfor %}

{% endmacro %}


