{#
        Suggestions:

        For PacBio CLR data:
                --max_cluster_bias_INS          100
                --diff_ratio_merging_INS        0.3
                --max_cluster_bias_DEL  200
                --diff_ratio_merging_DEL        0.5

        For PacBio CCS(HIFI) data:
                --max_cluster_bias_INS          1000
                --diff_ratio_merging_INS        0.9
                --max_cluster_bias_DEL  1000
                --diff_ratio_merging_DEL        0.5

        For ONT data:
                --max_cluster_bias_INS          100
                --diff_ratio_merging_INS        0.3
                --max_cluster_bias_DEL  100
                --diff_ratio_merging_DEL        0.3



positional arguments:
  [BAM]                 Sorted .bam file from NGMLR or Minimap2.
  reference             The reference genome in fasta format.
  output                Output VCF format file.
  work_dir              Work-directory for distributed jobs

optional arguments:
  -h, --help            show this help message and exit
  --version, -v         show program's version number and exit
  -t THREADS, --threads THREADS
                        Number of threads to use.[16]
  -b BATCHES, --batches BATCHES
                        Batch of genome segmentation interval.[10000000]
  -S SAMPLE, --sample SAMPLE
                        Sample name/id
  --retain_work_dir     Enable to retain temporary folder and files.
  --report_readid       Enable to report supporting read ids for each SV.

Collection of SV signatures:
  -p MAX_SPLIT_PARTS, --max_split_parts MAX_SPLIT_PARTS
                        Maximum number of split segments a read may be aligned before it is ignored. All split segments are considered when using -1. (Recommand -1 when applying assembly-based alignment.)[7]
  -q MIN_MAPQ, --min_mapq MIN_MAPQ
                        Minimum mapping quality value of alignment to be taken into account.[20]
  -r MIN_READ_LEN, --min_read_len MIN_READ_LEN
                        Ignores reads that only report alignments with not longer than bp.[500]
  -md MERGE_DEL_THRESHOLD, --merge_del_threshold MERGE_DEL_THRESHOLD
                        Maximum distance of deletion signals to be merged. In our paper, I used -md 500 to process HG002 real human sample data.[0]
  -mi MERGE_INS_THRESHOLD, --merge_ins_threshold MERGE_INS_THRESHOLD
                        Maximum distance of insertion signals to be merged. In our paper, I used -mi 500 to process HG002 real human sample data.[100]
  -include_bed INCLUDE_BED
                        Optional given bed file. Only detect SVs in regions in the BED file. [NULL]

Generation of SV clusters:
  -s MIN_SUPPORT, --min_support MIN_SUPPORT
                        Minimum number of reads that support a SV to be reported.[10]
  -l MIN_SIZE, --min_size MIN_SIZE
                        Minimum size of SV to be reported.[30]
  -L MAX_SIZE, --max_size MAX_SIZE
                        Maximum size of SV to be reported. All SVs are reported when using -1. [100000]
  -sl MIN_SIGLENGTH, --min_siglength MIN_SIGLENGTH
                        Minimum length of SV signal to be extracted.[10]

Computing genotypes:
  --genotype            Enable to generate genotypes.
  --gt_round GT_ROUND   Maximum round of iteration for alignments searching if perform genotyping.[500]

Force calling:
  -Ivcf IVCF            Optional given vcf file. Enable to perform force calling. [NULL]

Advanced:
  --max_cluster_bias_INS MAX_CLUSTER_BIAS_INS
                        Maximum distance to cluster read together for insertion.[100]
  --diff_ratio_merging_INS DIFF_RATIO_MERGING_INS
                        Do not merge breakpoints with basepair identity more than [0.3] for insertion.
  --max_cluster_bias_DEL MAX_CLUSTER_BIAS_DEL
                        Maximum distance to cluster read together for deletion.[200]
  --diff_ratio_merging_DEL DIFF_RATIO_MERGING_DEL
                        Do not merge breakpoints with basepair identity more than [0.5] for deletion.
  --max_cluster_bias_INV MAX_CLUSTER_BIAS_INV
                        Maximum distance to cluster read together for inversion.[500]
  --max_cluster_bias_DUP MAX_CLUSTER_BIAS_DUP
                        Maximum distance to cluster read together for duplication.[500]
  --max_cluster_bias_TRA MAX_CLUSTER_BIAS_TRA
                        Maximum distance to cluster read together for translocation.[50]
  --diff_ratio_filtering_TRA DIFF_RATIO_FILTERING_TRA
                        Filter breakpoints with basepair identity less than [0.6] for translocation.
  --remain_reads_ratio REMAIN_READS_RATIO
                        The ratio of reads remained in cluster. Set lower when the alignment data have high quality but recommand over 0.5.[1.0]
#}

{% macro cutesv(sample, aligner) %}

{%- set bam %}{{ sample.gltype }}/alignment/{{ aligner }}/{{ sample.name }}/{{ sample.name }}.{{ aligner }}.cram{% endset %}
{%- set temp_dir %}temp/{{ sample.gltype }}/constitutional_variant_calls/cutesv/{{ sample.name }}_{{ aligner }}{% endset %}
{%- set results_dir %}{{ sample.gltype }}/constitutional_variant_calls/cutesv/{{ sample.name }}_{{ aligner }}{% endset %}
{%- set all_vcf %}{{ results_dir }}/{{ sample.name }}.{{ aligner }}.cutesv.all.vcf.gz{% endset %}
{%- set pass_vcf %}{{ results_dir }}/{{ sample.name }}.{{ aligner }}.cutesv.pass.vcf.gz{% endset %}

- name: cutesv_{{ sample.name }}_{{ aligner }}
  input:
    - {{ bam }}
    - {{ bam }}.bai
    - {{ constants.grandcanyon.reference_fasta }}
  output:
    - {{ all_vcf }}
    - {{ temp_dir }}
  cpus: 8
  mem: 32G
  walltime: "24:00:00"
  queue_preset: "DEFAULT"
  container: {{ constants.tools.cutesv.container }}
  cmd: |
    set -eu
    set -o pipefail

    rm -r {{ temp_dir }} || true
    mkdir -p {{ temp_dir }}
    mkdir -p {{ results_dir }}

    cuteSV \
      {{ bam }} \
      {{ constants.grandcanyon.reference_fasta }} \
      {{ all_vcf }} \
      {{ temp_dir }} \
      {% if sample.rgpl == 'ont' %}
      --max_cluster_bias_INS 100 \
      --diff_ratio_merging_INS 0.3 \
      --max_cluster_bias_DEL 100 \
      --diff_ratio_merging_DEL 0.3 \
      {% elif sample.rgpl == 'hifi' %}
      --max_cluster_bias_INS 1000 \
      --diff_ratio_merging_INS 0.9 \
      --max_cluster_bias_DEL 1000 \
      --diff_ratio_merging_DEL 0.5 \
      {% endif %}
      --threads 8

{% endmacro %}
