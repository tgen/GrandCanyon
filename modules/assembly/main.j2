{% from 'modules/assembly/flye.j2' import flye with context %}
{% from 'modules/assembly/canu.j2' import canu with context %}
{% from 'modules/assembly/verkko.j2' import verkko with context %}
{% from 'modules/assembly/shasta.j2' import shasta with context %}
{% from 'modules/assembly/hifiasm.j2' import hifiasm with context %}

{%- macro assembly(samples) %}

  {% set pairs = [] %}
  {% for sample in samples.values()|selectattr('subGroup', 'eq', 'Constitutional')|selectattr('gltype', 'in', ['genome','genomephased']) %}
    {% set pair = {'project': project} %}
    {% do pair.update({'gltype': 'genome'}) %}
    {% do pair.update({'ont': []}) %}
    {% do pair.update({'pacbio': []}) %}
    {% do pair.update({'short': []}) %}
    {% set log_msg %}Collecting sequencing data types for {{ project }}, we will then attempt an assembly{% endset %}
    {{ log(log_msg, level='WARNING') }}
    {% set log_msg %}Parsing {{ sample.name }}{% endset %}
    {{ log(log_msg, level='WARNING') }}
    {% if sample.rgpl in ('ONT') %}
      {% for readgroup in sample.read_groups.values() %}
        {% do pair.ont.append(readgroup) %}
      {% endfor %}
      {% set log_msg %}{{ sample.name }} was added to ont list{% endset %}
      {{ log(log_msg, level='WARNING') }}
    {% elif sample.rgpl in ('PACBIO') %}
      {% for readgroup in sample.read_groups.values() %}
        {% do pair.ont.append(readgroup) %}
      {% endfor %}
      {% set log_msg %}{{ sample.name }} was added to pacbio list{% endset %}
      {{ log(log_msg, level='WARNING') }}
    {% else %}
      {% for readgroup in sample.read_groups.values() %}
        {% do pair.ont.append(readgroup) %}
      {% endfor %}
      {% set log_msg %}{{ sample.name }} did not match ont or pacbio patterns, so it is assumed to be short read data{% endset %}
      {{ log(log_msg, level='WARNING') }}
    {% endif %}
    {% do pairs.append(pair) %}
  {% endfor %}

  {% for pair in pairs %}
    {% if pair.gltype in 'exome' %}
      {% set taskPrefix = 'Exome' %}
    {% elif pair.gltype in ['genome','genomephased'] %}
      {% set taskPrefix = 'Genome' %}
    {% endif %}
    {% if tasks[taskPrefix+"_assembly_flye"]|default(false) %}
      {{- flye(pair) }}
    {% endif %}
    {% if tasks[taskPrefix+"_assembly_canu"]|default(false) %}
      {{- canu(pair) }}
    {% endif %}
    {% if tasks[taskPrefix+"_assembly_hifiasm"]|default(false) %}
      {{- hifiasm(pair) }}
    {% endif %}
    {% if tasks[taskPrefix+"_assembly_verkko"]|default(false) %}
      {{- verkko(pair) }}
    {% endif %}
    {% if tasks[taskPrefix+"_assembly_shasta"]|default(false) %}
      {{- shasta(pair) }}
    {% endif %}
  {% endfor %}

{% endmacro %}

