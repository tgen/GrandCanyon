{% from 'modules/assembly/flye.j2' import flye with context %}
{% from 'modules/assembly/canu.j2' import canu with context %}
{% from 'modules/assembly/verkko.j2' import verkko with context %}
{% from 'modules/assembly/shasta.j2' import shasta with context %}
{% from 'modules/assembly/hifiasm.j2' import hifiasm with context %}

{%- macro assembly(samples) %}

  {% set pair = {'project': project} %}
  {% do pair.update({'gltype': 'genome'}) %}
  {% do pair.update({'ont': []}) %}
  {% do pair.update({'pacbio': []}) %}
  {% do pair.update({'short': []}) %}
  {% for file in dataFiles|selectattr('subGroup', 'eq', 'Constitutional')|selectattr('gltype', 'in', ['genome','genomephased']) %}
    {% set log_msg %}Collecting sequencing data types for {{ project }}, we will then attempt an assembly{% endset %}
    {{ log(log_msg, level='WARNING') }}
    {{ log(log_msg, level='WARNING') }}
    {% if file.rgpl in ('ONT') %}
      {% do pair.ont.append(file) %}
    {% elif file.rgpl in ('PACBIO') %}
        {% do pair.pacbio.append(file) %}
    {% else %}
        {% do pair.short.append(file) %}
    {% endif %}
  {% endfor %}

    {% if pair.gltype in 'exome' %}
      {% set taskPrefix = 'Exome' %}
    {% elif pair.gltype in ['genome','genomephased'] %}
      {% set taskPrefix = 'Genome' %}
    {% endif %}
    {% if tasks[taskPrefix+"_assembly_flye"]|default(false) %}
      {{- flye(pair) }}
    {% endif %}
    {% if tasks[taskPrefix+"_assembly_canu"]|default(false) %}
      {{- canu(pair) }}
    {% endif %}
    {% if tasks[taskPrefix+"_assembly_hifiasm"]|default(false) %}
      {{- hifiasm(pair) }}
    {% endif %}
    {% if tasks[taskPrefix+"_assembly_verkko"]|default(false) %}
      {{- verkko(pair) }}
    {% endif %}
    {% if tasks[taskPrefix+"_assembly_shasta"]|default(false) %}
      {{- shasta(pair) }}
    {% endif %}

{% endmacro %}

