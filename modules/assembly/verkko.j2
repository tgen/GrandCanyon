{% macro verkko(pair) %}

{%- set temp_dir %}temp/{{ pair.gltype }}/assembly/verkko/{{ pair.project }}{% endset %}
{%- set results_dir %}{{ pair.gltype }}/assembly/verkko/{{ pair.project }}{% endset %}

{% set ontfqlist = [] %}
{% set hififqlist = [] %}

{% for rg in pair.pacbio %}
  {% for file in rg.data_files %}
    {% set pacbiofq %}temp/fastqs/{{ file.basename.split('.fastq.gz')[0] | replace(".", "_") }}.fastq.gz{% endset %}
    {% do hififqlist.append(pacbiofq) %}
  {% endfor %}
{% endfor %}

{% for rg in pair.ont %}
  {% for file in rg.data_files|selectattr('fastqCode', 'eq', 'duplex')|list %}
    {% set hifi %}temp/fastqs/{{ file.basename.split('.fastq.gz')[0] | replace(".", "_") }}.fastq.gz{% endset %}
    {% do hififqlist.append(ontfq) %}
  {% endfor %}
{% endfor %}

{% for rg in pair.ont %}
  {% for file in rg.data_files|selectattr('fastqCode', 'eq', 'simplex')|list %}
    {% set ontfq %}temp/fastqs/{{ file.basename.split('.fastq.gz')[0] | replace(".", "_") }}.fastq.gz{% endset %}
    {% do ontfqlist.append(ontfq) %}
  {% endfor %}
{% endfor %}

{% if hififqlist | length > 0 %}
- name: verkko_{{ pair.project }}
  input:
    {% for ontfq in ontfqlist %}
    - {{ ontfq }}
    {% endfor %}
    {% for hififq in hififqlist %}
    - {{ hififq }}
    {% endfor %}
  output: {{ results_dir }}
  cpus: 20
  mem: 200G
  walltime: "24:00:00"
  queue_preset: "DEFAULT"
  container: {{ constants.tools.verkko.container }}
  cmd: |
    set -eu
    set -o pipefail

    verkko \
      --local-cpus 20 \
      --local-memory 200 \
      {% if hififqlist | length > 0 %}
      --hifi "{{ hififqlist | join('" "') }}" \
      {% endif %}
      {% if ontfqlist | length > 0 %}
      --nano "{{ ontfqlist | join('" "') }}" \
      {% else %}
      --no-nano \
      {% endif %}
      --screen human \
      -d {{ results_dir }}

{% else %}
  {% set log_msg %}verkko was enabled, but no pacbio or ont duplex data was found. Verkko requires pacbio or ont duplex input data, so this task was skipped{% endset %}
  {{ log(log_msg, level='WARNING') }}
{% endif %}
{% endmacro %}

