{% macro pygmy_flair(sample, sample_bam, reference_fasta, gtf, SIRV=false) %}

{% if SIRV %}
  {% set temp_dir %}temp/{{ sample.gltype }}/quant/flair_SIRV/{{ sample.name }}{% endset %}
  {% set results_dir %}{{ sample.gltype }}/quant/flair_SIRV/{{ sample.name }}{% endset %}
  {% set input_fq %}temp/{{ sample.gltype }}/alignment/minimap2/{{ sample.name }}/pychopper/{{ sample.name }}/pychopper_all.fq{% endset %}
{% else %}
  {% set temp_dir %}temp/{{ sample.gltype }}/quant/flair/{{ sample.name }}{% endset %}
  {% set results_dir %}{{ sample.gltype }}/quant/flair/{{ sample.name }}{% endset %}
  {% set input_fq %}temp/{{ sample.gltype }}/alignment/minimap2/{{ sample.name }}/{{ sample.name }}_SIRVome_unmapped.fq{% endset %}
{% endif %}

{% if SIRV %}
- name: flair_SIRV_{{ sample.name }}
{% else %}
- name: flair_{{ sample.name }}
{% endif %}
  input:
    - {{ reference_fasta }}
    - {{ gtf }}
    - {{ sample_bam }}
    - {{ input_fq }}
  output:
    - {{ temp_dir }}/flair.collapse.isoforms.fa
    - {{ temp_dir }}/{{ sample.name }}_flair_top10.txt
  cpus: 10
  mem: 32G
  walltime: "4:00:00"
  queue_preset: "DEFAULT"
  container: {{ constants.tools.flair.container }}
  cmd: |
    set -e

    ROOT=${PWD}

    mkdir -p {{ temp_dir }}
    cd {{ temp_dir }}

    {# we already did alignment, skipping flair align step and converting bam to bed for flair correct #}
    bam2Bed12 \
      -i ${ROOT}/{{ sample_bam }} \
      > flair.aligned.bed
    flair correct \
      --query flair.aligned.bed \
      --genome {{ reference_fasta }} \
      --threads 10 \
      --gtf {{ gtf }}
    flair collapse \
      --query flair_all_corrected.bed \
      --genome {{ reference_fasta }} \
      --reads ${ROOT}/{{ input_fq }} \
      --gtf {{ gtf }} \
      --threads 10

    {# generate reads_manifest.tsv file for flair quantify #}
    printf "{{ sample.name }}\tcondition1\tbatch1\t${ROOT}/{{ sample_bam }}" > reads_manifest.tsv

    flair quantify \
      --reads_manifest reads_manifest.tsv \
      --sample_id_only \
      --threads 10 \
      --isoforms flair.collapse.isoforms.fa
    flair quantify \
      --reads_manifest reads_manifest.tsv \
      --sample_id_only \
      --threads 10 \
      --isoforms flair.collapse.isoforms.fa \
      --tpm

    {# generate file with the 10 longest isoforms #}
    awk '/^>/ {printf("%s%s\t",(N>0?"\n":""),$0);N++;next;} {printf("%s",$0);} END {printf("\n");}' flair.collapse.isoforms.fa |\
    awk '{printf("%d\t%s\t%s\t%s\n",length($2),$1,$1,$2);}' |\
    sort -t $'\t' -k1,1nr | cut -f 1,2 | head > {{ sample.name }}_flair_top10.txt

{% endmacro %}

