{% macro pygmy_flair(sample, sample_bam, reference_fasta, gtf, SIRV=false) %}

{% if SIRV %}
  {% set temp_dir %}temp/{{ sample.gltype }}/quant/flair_SIRV/{{ sample.name }}{% endset %}
  {% set results_dir %}{{ sample.gltype }}/quant/flair_SIRV/{{ sample.name }}{% endset %}
  {% set input_fq %}temp/{{ sample.gltype }}/alignment/minimap2/{{ sample.name }}/pychopper/{{ sample.name }}/pychopper_all.fq{% endset %}
{% else %}
  {% set temp_dir %}temp/{{ sample.gltype }}/quant/flair/{{ sample.name }}{% endset %}
  {% set results_dir %}{{ sample.gltype }}/quant/flair/{{ sample.name }}{% endset %}
  {% set input_fq %}temp/{{ sample.gltype }}/alignment/minimap2/{{ sample.name }}/{{ sample.name }}_SIRVome_unmapped.fq{% endset %}
{% endif %}

{% if SIRV %}
- name: flair_SIRV_{{ sample.name }}
{% else %}
- name: flair_{{ sample.name }}
{% endif %}
  input:
    - {{ reference_fasta }}
    - {{ gtf }}
    - {{ sample_bam }}
    - {{ input_fq }}
  output:
    - {{ temp_dir }}/flair.collapse.isoforms.fa
    - {{ temp_dir }}/{{ sample.name }}_flair_top10.txt
  cpus: 10
  mem: 32G
  walltime: "4:00:00"
  queue_preset: "DEFAULT"
  container: {{ constants.tools.flair.container }}
  cmd: |

    {# note: this step performs flair for read correction, annotation, and quantification #}
    {# input: human aligned genome bam #}
    {# output: isoforms.fa, quantification, gtf #}

    ROOT=${PWD}

    mkdir -p {{ temp_dir }}
    cd {{ temp_dir }}

    {# we already did alignment, skipping flair align step and converting bam to bed for flair correct #}
    bam2Bed12 \
      -i ${ROOT}/{{ sample_bam }} \
      > flair.aligned.bed
    flair correct \
      -q flair.aligned.bed \
      -g {{ reference_fasta }} \
      -t 10 \
      -f {{ gtf }}
    flair collapse \
      -g {{ reference_fasta }} \
      -r ${ROOT}/{{ input_fq }} \
      -f {{ gtf }} \
      -q flair_all_corrected.bed \
      -t 10

    {# generate reads_mainfest.tsv file for flair quantify #}
    printf "{{ sample.name }}\t{{ sample.name }}\tbatch1\t${ROOT}/{{ sample_bam }}" > reads_manifest.tsv.tmp
    awk '{gsub("_","", $1)}1' reads_manifest.tsv.tmp | awk '{gsub("_","", $2)}1' | awk '{gsub("_","", $3)}1' > reads_manifest.tsv.tmp2
    sed -i 's/ /\t/g' reads_manifest.tsv.tmp2
    ( printf "\xff\xfe" ; iconv -f utf-8 -t utf-16le reads_manifest.tsv.tmp2 ) > reads_manifest.tsv

    flair quantify \
      -r reads_manifest.tsv \
      -i flair.collapse.isoforms.fa
    flair quantify \
      -r reads_manifest.tsv \
      -i flair.collapse.isoforms.fa \
      --tpm

    {# generate file with the 10 longest isoforms #}
    awk '/^>/ {printf("%s%s\t",(N>0?"\n":""),$0);N++;next;} {printf("%s",$0);} END {printf("\n");}' flair.collapse.isoforms.fa |\
    awk '{printf("%d\t%s\t%s\t%s\n",length($2),$1,$1,$2);}' |\
    sort -t $'\t' -k1,1nr | cut -f 1,2 | head > {{ sample.name }}_flair_top10.txt

{% endmacro %}

